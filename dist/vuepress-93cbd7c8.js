#!/usr/bin/env node
import*as t from"glob";import e from"fs";import r from"sharp";import n from"path";function o(e,t){var r,n=Object.keys(e);return Object.getOwnPropertySymbols&&(r=Object.getOwnPropertySymbols(e),t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)),n}function i(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?o(Object(r),!0).forEach(function(t){l(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):o(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function a(){a=function(){return u};var u={},t=Object.prototype,c=t.hasOwnProperty,l=Object.defineProperty||function(t,e,r){t[e]=r.value},e="function"==typeof Symbol?Symbol:{},n=e.iterator||"@@iterator",r=e.asyncIterator||"@@asyncIterator",o=e.toStringTag||"@@toStringTag";function i(t,e,r){return Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{i({},"")}catch(u){i=function(t,e,r){return t[e]=r}}function s(t,e,r,n){var o,i,a,u,e=Object.create((e&&e.prototype instanceof h?e:h).prototype),n=new E(n||[]);return l(e,"_invoke",{value:(o=t,i=r,a=n,u="suspendedStart",function(t,e){if("executing"===u)throw Error("Generator is already running");if("completed"===u){if("throw"===t)throw e;return j()}for(a.method=t,a.arg=e;;){var r=a.delegate;if(r){r=function t(e,r){var n=r.method,o=e.iterator[n];if(void 0===o)return r.delegate=null,"throw"===n&&e.iterator.return&&(r.method="return",r.arg=void 0,t(e,r),"throw"===r.method)||"return"!==n&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+n+"' method")),p;n=f(o,e.iterator,r.arg);if("throw"===n.type)return r.method="throw",r.arg=n.arg,r.delegate=null,p;o=n.arg;return o?o.done?(r[e.resultName]=o.value,r.next=e.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,p):o:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,p)}(r,a);if(r){if(r===p)continue;return r}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if("suspendedStart"===u)throw u="completed",a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);u="executing";r=f(o,i,a);if("normal"===r.type){if(u=a.done?"completed":"suspendedYield",r.arg===p)continue;return{value:r.arg,done:a.done}}"throw"===r.type&&(u="completed",a.method="throw",a.arg=r.arg)}})}),e}function f(t,e,r){try{return{type:"normal",arg:t.call(e,r)}}catch(t){return{type:"throw",arg:t}}}u.wrap=s;var p={};function h(){}function d(){}function v(){}var e={},y=(i(e,n,function(){return this}),Object.getPrototypeOf),y=y&&y(y(O([]))),g=(y&&y!==t&&c.call(y,n)&&(e=y),v.prototype=h.prototype=Object.create(e));function b(t){["next","throw","return"].forEach(function(e){i(t,e,function(t){return this._invoke(e,t)})})}function m(a,u){var e;l(this,"_invoke",{value:function(r,n){function t(){return new u(function(t,e){!function e(t,r,n,o){var i,t=f(a[t],a,r);if("throw"!==t.type)return(r=(i=t.arg).value)&&"object"==typeof r&&c.call(r,"__await")?u.resolve(r.__await).then(function(t){e("next",t,n,o)},function(t){e("throw",t,n,o)}):u.resolve(r).then(function(t){i.value=t,n(i)},function(t){return e("throw",t,n,o)});o(t.arg)}(r,n,t,e)})}return e=e?e.then(t,t):t()}})}function w(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function x(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function E(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(w,this),this.reset(!0)}function O(e){if(e){var r,t=e[n];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length))return r=-1,(t=function t(){for(;++r<e.length;)if(c.call(e,r))return t.value=e[r],t.done=!1,t;return t.value=void 0,t.done=!0,t}).next=t}return{next:j}}function j(){return{value:void 0,done:!0}}return l(g,"constructor",{value:d.prototype=v,configurable:!0}),l(v,"constructor",{value:d,configurable:!0}),d.displayName=i(v,o,"GeneratorFunction"),u.isGeneratorFunction=function(t){t="function"==typeof t&&t.constructor;return!!t&&(t===d||"GeneratorFunction"===(t.displayName||t.name))},u.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,v):(t.__proto__=v,i(t,o,"GeneratorFunction")),t.prototype=Object.create(g),t},u.awrap=function(t){return{__await:t}},b(m.prototype),i(m.prototype,r,function(){return this}),u.AsyncIterator=m,u.async=function(t,e,r,n,o){void 0===o&&(o=Promise);var i=new m(s(t,e,r,n),o);return u.isGeneratorFunction(e)?i:i.next().then(function(t){return t.done?t.value:i.next()})},b(g),i(g,o,"Generator"),i(g,n,function(){return this}),i(g,"toString",function(){return"[object Generator]"}),u.keys=function(t){var e,r=Object(t),n=[];for(e in r)n.push(e);return n.reverse(),function t(){for(;n.length;){var e=n.pop();if(e in r)return t.value=e,t.done=!1,t}return t.done=!0,t}},u.values=O,E.prototype={constructor:E,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(x),!t)for(var e in this)"t"===e.charAt(0)&&c.call(this,e)&&!isNaN(+e.slice(1))&&(this[e]=void 0)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(r){if(this.done)throw r;var n=this;function t(t,e){return i.type="throw",i.arg=r,n.next=t,e&&(n.method="next",n.arg=void 0),!!e}for(var e=this.tryEntries.length-1;0<=e;--e){var o=this.tryEntries[e],i=o.completion;if("root"===o.tryLoc)return t("end");if(this.prev>=o.tryLoc){var a=c.call(o,"catchLoc"),u=c.call(o,"finallyLoc");if(a&&u){if(o.catchLoc>this.prev)return t(o.catchLoc,!0);if(o.finallyLoc>this.prev)return t(o.finallyLoc)}else if(a){if(o.catchLoc>this.prev)return t(o.catchLoc,!0)}else{if(!u)throw Error("try statement without catch or finally");if(o.finallyLoc>this.prev)return t(o.finallyLoc)}}}},abrupt:function(t,e){for(var r=this.tryEntries.length-1;0<=r;--r){var n=this.tryEntries[r];if(this.prev>=n.tryLoc&&c.call(n,"finallyLoc")&&n.finallyLoc>this.prev){var o=n;break}}var i=(o=o&&("break"===t||"continue"===t)&&e>=o.tryLoc&&o.finallyLoc>=e?null:o)?o.completion:{};return i.type=t,i.arg=e,o?(this.method="next",this.next=o.finallyLoc,p):this.complete(i)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),p},finish:function(t){for(var e=this.tryEntries.length-1;0<=e;--e){var r=this.tryEntries[e];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),x(r),p}},catch:function(t){for(var e=this.tryEntries.length-1;0<=e;--e){var r,n,o=this.tryEntries[e];if(o.tryLoc===t)return"throw"===(r=o.completion).type&&(n=r.arg,x(o)),n}throw Error("illegal catch attempt")},delegateYield:function(t,e,r){return this.delegate={iterator:O(t),resultName:e,nextLoc:r},"next"===this.method&&(this.arg=void 0),p}},u}function u(t,e,r,n,o,i,a){try{var u=t[i](a),c=u.value}catch(t){return void r(t)}u.done?e(c):Promise.resolve(c).then(n,o)}function c(c){return function(){var t=this,a=arguments;return new Promise(function(e,r){var n=c.apply(t,a);function o(t){u(n,e,r,o,i,"next",t)}function i(t){u(n,e,r,o,i,"throw",t)}o(void 0)})}}function l(t,e,r){return n=function(t){if("object"!=typeof t||null===t)return t;var e=t[Symbol.toPrimitive];if(void 0===e)return String(t);e=e.call(t,"string");if("object"!=typeof e)return e;throw new TypeError("@@toPrimitive must return a primitive value.")}(e),(e="symbol"==typeof n?n:n+"")in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t;var n}function s(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var r=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=r){var n,o,i,a,u=[],c=!0,l=!1;try{if(i=(r=r.call(t)).next,0===e){if(Object(r)!==r)return;c=!1}else for(;!(c=(n=i.call(r)).done)&&(u.push(n.value),u.length!==e);c=!0);}catch(t){l=!0,o=t}finally{try{if(!c&&null!=r.return&&(a=r.return(),Object(a)!==a))return}finally{if(l)throw o}}return u}}(t,e)||p(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function f(t){return function(t){if(Array.isArray(t))return h(t)}(t)||function(){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}()||p(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function p(t,e){var r;if(t)return"string"==typeof t?h(t,e):"Map"===(r="Object"===(r=Object.prototype.toString.call(t).slice(8,-1))&&t.constructor?t.constructor.name:r)||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?h(t,e):void 0}function h(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=Array(e);r<e;r++)n[r]=t[r];return n}var v=["jpg","jpeg","gif","png"],d=Object.freeze({appName:"photomaker",version:"1.0.0",storePath:"/photomaker",acceptExt:v,ext:v.join(","),webp:!1,watermark:!1,quality:80}),y=["cover","contain","fill","inside","outside"];function g(t){return b.apply(this,arguments)}function b(){return(b=c(a().mark(function t(e){var n,o,i,u,c,l,s,f,p,h,d,v;return a().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(n=e.input,o=e.output,i=e.quality,u=e.webp,c=e.executeExt,s=(l=void 0===(l=e.resize)?{}:l).height,f=l.fit,p=l.background,(l=l.width)||s)return d={withoutEnlargement:!0},l&&(d.width=l),s&&(d.height=s),f&&(d.fit=f),p&&(d.background=p),t.next=10,r(n).withMetadata().resize(d).toBuffer({resolveWithObject:!0});t.next=18;break;case 10:return h=t.sent.data,t.next=15,r(h).toBuffer();case 15:h=t.sent,t.next=21;break;case 18:return t.next=20,r(n).toBuffer();case 20:h=t.sent;case 21:if(u)return t.abrupt("return",r(h).webp({quality:i}).toFile(o));t.next=23;break;case 23:t.t0=c,t.next="jpg"===t.t0?26:"png"===t.t0?28:"jpeg"===t.t0?30:"gif"===t.t0?32:34;break;case 26:return v=r(h).jpeg({quality:i}).toFile(o),t.abrupt("break",34);case 28:return v=r(h).png({quality:i}).toFile(o),t.abrupt("break",34);case 30:return v=r(h).jpeg({quality:i}).toFile(o),t.abrupt("break",34);case 32:return v=r(h).gif({quality:i}).toFile(o),t.abrupt("break",34);case 34:return t.abrupt("return",v);case 35:case"end":return t.stop()}},t)}))).apply(this,arguments)}var m=function(t){var e,r=t.webp,t=t.fullFileName,n=null==t?void 0:t.substring(0,null==t?void 0:t.lastIndexOf(".")),t=null==t?void 0:t.substring(null==t?void 0:t.lastIndexOf("."),null==t?void 0:t.length);return e=n&&t?"".concat(n).concat(r?".webp":t):e},w=function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},e={webp:d.webp,quality:d.quality,resize:{}},r=t.quality,n=t.resize,n=void 0===n?{}:n,o=d.acceptExt,i=t.ext.toLowerCase().split(","),a=o.filter(function(t){return-1<i.indexOf(t)});return e.ext=(null!=a&&a.length?a:o).join(","),Number(null==n?void 0:n.width)&&(e.resize.width=parseInt(Number(null==n?void 0:n.width))),Number(null==n?void 0:n.height)&&(e.resize.height=parseInt(Number(null==n?void 0:n.height))),x(null==n?void 0:n.fit)&&(e.resize.fit=null==n||null==(a=n.fit)?void 0:(""+a).toLowerCase()),O(null==n?void 0:n.background)&&(e.resize.background=null==n?void 0:n.background),E(r)&&(e.quality=parseInt(Number(r)),100<e.quality)&&(e.quality=100),null!=t&&t.input&&(e.input=t.input),null!=t&&t.output&&(e.output=t.output),null!=t&&t.webp&&(e.webp=t.webp),e},x=function(t){var e;return e=t&&(t=null==t?void 0:(""+t).toLowerCase(),y.includes(t))?t:e},E=function(t){return!isNaN(Number(t,10))},O=function(t){var e;return e=t&&/^#([0-9a-fA-F]{6}|[0-9a-fA-F]{3}|[0-9a-fA-F]{8})$/.test(t)?t:e};function j(i){var t=(1<arguments.length&&void 0!==arguments[1]?arguments[1]:{}).isRelativeToScript,t=void 0!==t&&t,r=n.sep,o=n.isAbsolute(i)?r:"",a=t?__dirname:".";return i.split(r).reduce(function(r,o){o=n.resolve(a,r,o);try{e.mkdirSync(o)}catch(t){if("EEXIST"===t.code)return o;if("ENOENT"===t.code)throw Error("EACCES: permission denied, mkdir '".concat(r,"'"));r=-1<["EACCES","EPERM","EISDIR"].indexOf(t.code);if(!r||o===n.resolve(i))throw t}return o},o)}var k=t.glob,L=function(o){return r=c(a().mark(function t(u){var r,l,s,f,n,p;return a().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return r=void 0===(r=u.ext)?d.ext:r,l=u.webp,s=o.dir.public(),f=s,e.existsSync(n=s+d.storePath)&&e.rmSync(n,{recursive:!0}),j(n),n=k.sync("".concat(s,"/**/*.{").concat(r,"}"),{matchBase:!0}),P(n,s),p=[],n.forEach(function(){var e=c(a().mark(function t(e){var r,n,o;return a().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(r=e.substring(e.lastIndexOf("/"),e.length).substring(1),r=m({webp:l,fullFileName:r})){t.next=4;break}return t.abrupt("return");case 4:n=S(e,s),n="".concat(f).concat(d.storePath).concat(n).concat(r),o=e.substring(e.lastIndexOf(".")+1,e.length),p.push(g(i(i({},u),{},{input:e,output:n,executeExt:o})));case 8:case"end":return t.stop()}},t)}));return function(t){return e.apply(this,arguments)}}()),t.next=12,Promise.allSettled(p);case 12:return t.abrupt("return",p.length);case 14:case"end":return t.stop()}},t)})),function(t){return r.apply(this,arguments)};var r},S=function(t,e){var r=t.substring(t.lastIndexOf("/"),t.length).substring(1);return null==t||null==(t=t.replace(e,""))?void 0:t.replace(r,"")},P=function(t,e){var r=[];t.forEach(function(t){t=t.substring(0,t.lastIndexOf("/")+1);r.push(e+d.storePath+t.replace(e,""))}),(r=(r=Array.from(new Set(f(r)))).filter(function(t){return t})).forEach(function(t){return j(t)})};function N(t,u){u=u||{},t.core.ruler.before("linkify","image_figures",function(t){for(var e=1,r=t.tokens.length;e<r-1;++e){var n,o,i,a=t.tokens[e];"inline"!==a.type||!a.children||1===a.children.length&&"image"!==a.children[0].type||1<a.children.length&&!A(a.children)||0!==e&&"paragraph_open"!==t.tokens[e-1].type||e!==r-1&&"paragraph_close"!==t.tokens[e+1].type||(a=null==(a=A(a.children))||null==(a=a.attrs)?void 0:a.find(function(t){return"src"===s(t,1)[0]}))&&2<=(null==a?void 0:a.length)&&!I(null==a?void 0:a[1])&&(n=(i=a[1]).startsWith("/"),null!=(o=u)&&o.webp?(i=null==(o=i)?void 0:o.substring(0,null==(o=i)?void 0:o.lastIndexOf(".")),a[1]="".concat(d.storePath).concat(n?"":"/").concat(i,".webp")):null!=(o=u)&&o.ext&&(a[1]="".concat(d.storePath).concat(n?"":"/").concat(a[1])))}})}var I=function(t){return/^(https?:\/\/(([a-zA-Z0-9]+-?)+[a-zA-Z0-9]+\.)+[a-zA-Z]+)(:\d+)?(\/.*)?(\?.*)?(#.*)?$/.test(t)},A=function(t){var e;return t.forEach(function(t){"image"===t.type&&(e=t)}),e},_=i({},d),q=function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t={ext:(null==t?void 0:t.ext)||d.ext,webp:(null==t?void 0:t.webp)||d.webp,resize:(null==t?void 0:t.resize)||{},quality:(null==t?void 0:t.quality)||d.quality},t=w(t),n=i(i({},_),t);return function(t){return{name:d.appName,extendsMarkdown:function(t,e){t.use(N,i({},n))},onInitialized:(r=c(a().mark(function t(e){return a().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=3,L(e)(n);case 3:case 7:case"end":return t.stop()}},t)})),function(t){return r.apply(this,arguments)}),onGenerated:function(t){t=t.dir.public(),k.sync("".concat(t,"/**/*.webp"),{matchBase:!0}).forEach(function(t){return e.unlinkSync(t)})}};var r}};export{d as P,c as _,a,f as b,g as c,i as d,w as e,j as m,m as p,q as v};
