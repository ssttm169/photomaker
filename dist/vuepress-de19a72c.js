#!/usr/bin/env node
import{_ as t,a as e,b as n,c as r,d as i}from"./vendor-5fff49e8.js";import{glob as a}from"glob";import u from"fs";import o from"sharp";import c from"path";var l=["jpg","jpeg","gif","png"],s=Object.freeze({appName:"photomaker",version:"1.0.0",storePath:"/photomaker",acceptExt:l,ext:l.join(","),webp:!1,watermark:!1,quality:80}),f=["cover","contain","fill","inside","outside"];function p(t){return d.apply(this,arguments)}function d(){return(d=t(e().mark(function t(n){var r,i,a,u,s,c,l,p,f,d,h,v;return e().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(r=n.input,i=n.output,a=n.quality,u=n.webp,s=n.executeExt,l=(c=void 0===(c=n.resize)?{}:c).height,p=c.fit,f=c.background,(c=c.width)||l)return h={withoutEnlargement:!0},c&&(h.width=c),l&&(h.height=l),p&&(h.fit=p),f&&(h.background=f),t.next=10,o(r).withMetadata().resize(h).toBuffer({resolveWithObject:!0});t.next=18;break;case 10:return d=t.sent.data,t.next=15,o(d).toBuffer();case 15:d=t.sent,t.next=21;break;case 18:return t.next=20,o(r).toBuffer();case 20:d=t.sent;case 21:if(u)return t.abrupt("return",o(d).webp({quality:a}).toFile(i));t.next=23;break;case 23:t.t0=s,t.next="jpg"===t.t0?26:"png"===t.t0?28:"jpeg"===t.t0?30:"gif"===t.t0?32:34;break;case 26:return v=o(d).jpeg({quality:a}).toFile(i),t.abrupt("break",34);case 28:return v=o(d).png({quality:a}).toFile(i),t.abrupt("break",34);case 30:return v=o(d).jpeg({quality:a}).toFile(i),t.abrupt("break",34);case 32:return v=o(d).gif({quality:a}).toFile(i),t.abrupt("break",34);case 34:return t.abrupt("return",v);case 35:case"end":return t.stop()}},t)}))).apply(this,arguments)}var v=function(t){var e,n=t.webp,t=t.fullFileName,r=null==t?void 0:t.substring(0,null==t?void 0:t.lastIndexOf(".")),t=null==t?void 0:t.substring(null==t?void 0:t.lastIndexOf("."),null==t?void 0:t.length);return e=r&&t?"".concat(r).concat(n?".webp":t):e},h=function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},e={webp:s.webp,quality:s.quality,resize:{}},n=t.quality,r=t.resize,r=void 0===r?{}:r,i=s.acceptExt,a=t.ext.toLowerCase().split(","),u=i.filter(function(t){return-1<a.indexOf(t)});return e.ext=(null!=u&&u.length?u:i).join(","),Number(null==r?void 0:r.width)&&(e.resize.width=parseInt(Number(null==r?void 0:r.width))),Number(null==r?void 0:r.height)&&(e.resize.height=parseInt(Number(null==r?void 0:r.height))),b(null==r?void 0:r.fit)&&(e.resize.fit=null==r||null==(u=r.fit)?void 0:(""+u).toLowerCase()),m(null==r?void 0:r.background)&&(e.resize.background=null==r?void 0:r.background),g(n)&&(e.quality=parseInt(Number(n)),100<e.quality)&&(e.quality=100),null!=t&&t.input&&(e.input=t.input),null!=t&&t.output&&(e.output=t.output),null!=t&&t.webp&&(e.webp=t.webp),e},b=function(t){var e;return e=t&&(t=null==t?void 0:(""+t).toLowerCase(),f.includes(t))?t:e},g=function(t){return!isNaN(Number(t,10))},m=function(t){var e;return e=t&&/^#([0-9a-fA-F]{6}|[0-9a-fA-F]{3}|[0-9a-fA-F]{8})$/.test(t)?t:e};function w(r){var t=(1<arguments.length&&void 0!==arguments[1]?arguments[1]:{}).isRelativeToScript,t=void 0!==t&&t,e=c.sep,n=c.isAbsolute(r)?e:"",i=t?__dirname:".";return r.split(e).reduce(function(t,e){var n=c.resolve(i,t,e);try{u.mkdirSync(n)}catch(e){if("EEXIST"===e.code)return n;if("ENOENT"===e.code)throw Error("EACCES: permission denied, mkdir '".concat(t,"'"));t=-1<["EACCES","EPERM","EISDIR"].indexOf(e.code);if(!t||n===c.resolve(r))throw e}return n},n)}var x=function(b){return n=t(e().mark(function n(o){var i,c,l,f,d,h;return e().wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return i=void 0===(i=o.ext)?s.ext:i,c=o.webp,l=b.dir.public(),f=l,u.existsSync(d=l+s.storePath)&&u.rmSync(d,{recursive:!0}),w(d),d=a.sync("".concat(l,"/**/*.{").concat(i,"}"),{matchBase:!0}),k(d,l),h=[],d.forEach(function(){var n=t(e().mark(function t(n){var i,a,u;return e().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(i=n.substring(n.lastIndexOf("/"),n.length).substring(1),i=v({webp:c,fullFileName:i})){t.next=4;break}return t.abrupt("return");case 4:a=y(n,l),a="".concat(f).concat(s.storePath).concat(a).concat(i),u=n.substring(n.lastIndexOf(".")+1,n.length),h.push(p(r(r({},o),{},{input:n,output:a,executeExt:u})));case 8:case"end":return t.stop()}},t)}));return function(t){return n.apply(this,arguments)}}()),n.next=12,Promise.allSettled(h);case 12:return n.abrupt("return",h.length);case 14:case"end":return n.stop()}},n)})),function(t){return n.apply(this,arguments)};var n},y=function(t,e){var n=t.substring(t.lastIndexOf("/"),t.length).substring(1);return null==t||null==(t=t.replace(e,""))?void 0:t.replace(n,"")},k=function(t,e){var r=[];t.forEach(function(t){t=t.substring(0,t.lastIndexOf("/")+1);r.push(e+s.storePath+t.replace(e,""))}),(r=(r=Array.from(new Set(n(r)))).filter(function(t){return t})).forEach(function(t){return w(t)})};function E(t,c){c=c||{},t.core.ruler.before("linkify","image_figures",function(t){for(var e=1,n=t.tokens.length;e<n-1;++e){var r,a,u,o=t.tokens[e];"inline"!==o.type||!o.children||1===o.children.length&&"image"!==o.children[0].type||1<o.children.length&&!z(o.children)||0!==e&&"paragraph_open"!==t.tokens[e-1].type||e!==n-1&&"paragraph_close"!==t.tokens[e+1].type||(o=null==(o=z(o.children))||null==(o=o.attrs)?void 0:o.find(function(t){return"src"===i(t,1)[0]}))&&2<=(null==o?void 0:o.length)&&!q(null==o?void 0:o[1])&&(r=(u=o[1]).startsWith("/"),null!=(a=c)&&a.webp?(u=null==(a=u)?void 0:a.substring(0,null==(a=u)?void 0:a.lastIndexOf(".")),o[1]="".concat(s.storePath).concat(r?"":"/").concat(u,".webp")):null!=(a=c)&&a.ext&&(o[1]="".concat(s.storePath).concat(r?"":"/").concat(o[1])))}})}var q=function(t){return/^(https?:\/\/(([a-zA-Z0-9]+-?)+[a-zA-Z0-9]+\.)+[a-zA-Z]+)(:\d+)?(\/.*)?(\?.*)?(#.*)?$/.test(t)},z=function(t){var e;return t.forEach(function(t){"image"===t.type&&(e=t)}),e},I=r({},s),N=function(){var n=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},n={ext:(null==n?void 0:n.ext)||s.ext,webp:(null==n?void 0:n.webp)||s.webp,resize:(null==n?void 0:n.resize)||{},quality:(null==n?void 0:n.quality)||s.quality},n=h(n),o=r(r({},I),n);return function(n){return{name:s.appName,extendsMarkdown:function(t,e){t.use(E,r({},o))},onInitialized:(i=t(e().mark(function t(n){return e().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=3,x(n)(o);case 3:case 7:case"end":return t.stop()}},t)})),function(t){return i.apply(this,arguments)}),onGenerated:function(t){t=t.dir.public(),a.sync("".concat(t,"/**/*.webp"),{matchBase:!0}).forEach(function(t){return u.unlinkSync(t)})}};var i}};export{s as P,h as a,p as c,w as m,v as p,N as v};
